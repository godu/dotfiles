#!/bin/sh -e

_dir_root="/usr"
_dir_install=$_dir_root"/share/node"
_dir_src=$_dir_root"/src/node"

_node_github="git://github.com/joyent/node.git"
_node_version=`curl -s http://nodejs.org/dist/latest/ | egrep -m 1 -o 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1`
_bash_file="/etc/profile.d/nodejs.sh"

_whoami=`whoami`

case $_whoami in
    root)
        echo "You're root! *with great power comes great responsibility*"
    
        if [ ! -d "$_dir_src" ]; then

            echo "1/6 Install"
            echo "2/6 Clone"
            git clone $_node_github $_dir_src >/dev/null
            cd $_dir_src
        else
            cd $_dir_src
            echo "1/6 Update"
            git fetch
            echo "2/6 Checkout"
        fi

        _current_branch=`git describe`

        if [ "$_current_branch" != "$_node_version" ]; then
            git checkout $_node_version >/dev/null
            echo "3/6 Configure"
            ./configure --prefix=$_dir_install >/dev/null
            echo "4/6 Make"
            gmake >/dev/null
            echo "5/6 Install"
            gmake install >/dev/null
        fi

        export PATH=$PATH:$_dir_install/bin
        export NODE_PATH=$_dir_install:$_dir_install/lib/node_modules

        echo "6/6 Update NPM"
        npm update npm

        if [ ! -f $_bash_file ]; then
            echo "6/6 Add to PATH"
            touch $_bash_file;
            echo "#!/bin/sh" > $_bash_file
            echo "# com" >> $_bash_file
            echo "export PATH=\$PATH:$_dir_install/bin" >> $_bash_file
            echo "export NODE_PATH=$_dir_install:$_dir_install/lib/node_modules" >> $_bash_file
        fi
    ;;
    *)
        echo "Dude, You ain't root :("
    ;;
esac
